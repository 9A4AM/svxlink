/**
@file	 AsyncAudioInterpolator.cpp
@brief   A_brief_description_for_this_file
@author  Tobias Blomberg / SM0SVX
@date	 2008-04-06

\verbatim
Original code by by Grant R. Griffin modified by Tobias Blomberg / SM0SVX.
Provided by Iowegian's "dspGuru" service (http://www.dspguru.com).
Copyright 2001, Iowegian International Corporation (http://www.iowegian.com)

                         The Wide Open License (WOL)

Permission to use, copy, modify, distribute and sell this software and its
documentation for any purpose is hereby granted without fee, provided that
the above copyright notice and this license appear in all source copies. 
THIS SOFTWARE IS PROVIDED "AS IS" WITHOUT EXPRESS OR IMPLIED WARRANTY OF
ANY KIND. See http://www.dspguru.com/wol.htm for more information.
\endverbatim
*/



/****************************************************************************
 *
 * System Includes
 *
 ****************************************************************************/



/****************************************************************************
 *
 * Project Includes
 *
 ****************************************************************************/



/****************************************************************************
 *
 * Local Includes
 *
 ****************************************************************************/

#include "AsyncAudioInterpolator.h"



/****************************************************************************
 *
 * Namespaces to use
 *
 ****************************************************************************/

using namespace std;
using namespace Async;



/****************************************************************************
 *
 * Defines & typedefs
 *
 ****************************************************************************/



/****************************************************************************
 *
 * Local class definitions
 *
 ****************************************************************************/



/****************************************************************************
 *
 * Prototypes
 *
 ****************************************************************************/



/****************************************************************************
 *
 * Exported Global Variables
 *
 ****************************************************************************/




/****************************************************************************
 *
 * Local Global Variables
 *
 ****************************************************************************/

/*
Parks-McClellan FIR Filter Design

Filter type: Low pass
Passband: 0 - 0.07291666666666666667
Order: 257
Passband ripple: 0.1 dB
Transition band: 0.010416667
Stopband attenuation: 60.0 dB
*/
static const float p_H[] =
{
  -7.515544038614662E-4,
  -3.749212927272262E-4,
  -3.672286989580432E-4,
  -2.795995105134109E-4,
  -1.1302822556929583E-4,
  1.1449907195741894E-4,
  3.684946565411867E-4,
  6.025817992035853E-4,
  7.687197868509025E-4,
  8.295882692759705E-4,
  7.65999855244165E-4,
  5.815008317447361E-4,
  3.112974111527295E-4,
  7.009460790638146E-6,
  -2.6512193672629554E-4,
  -4.4378936126212193E-4,
  -4.8448220172512884E-4,
  -3.717306572653342E-4,
  -1.254616407409903E-4,
  2.008423669415105E-4,
  5.31298393976394E-4,
  7.836728631828374E-4,
  8.880806343799871E-4,
  8.06414523551526E-4,
  5.415668869773104E-4,
  1.4220976499232748E-4,
  -3.073389722173345E-4,
  -7.039569659590131E-4,
  -9.493462386505837E-4,
  -9.741753694341827E-4,
  -7.573080079609536E-4,
  -3.3417774858638923E-4,
  2.0742040729975975E-4,
  7.446435043276913E-4,
  0.001147404855294023,
  0.0013082144879538017,
  0.0011709266198968425,
  7.471071379296708E-4,
  1.1840280342887127E-4,
  -5.784712278437567E-4,
  -0.0011808734837233828,
  -0.0015378439198133586,
  -0.0015471528670520397,
  -0.001183475558895642,
  -5.096807459169467E-4,
  3.3279867848702566E-4,
  0.001152244506396169,
  0.0017501592614373124,
  0.001968171371702879,
  0.0017291494432319543,
  0.0010609488372002507,
  9.651080349715515E-5,
  -9.515076717914393E-4,
  -0.001836694397785154,
  -0.0023362150309353667,
  -0.0023059537145225933,
  -0.001719951714741682,
  -6.843917945666481E-4,
  5.800943184252537E-4,
  0.0017839974961737681,
  0.0026344799267518215,
  0.0029054873877452656,
  0.0024962485484619486,
  0.0014631138946034443,
  1.5782101532487468E-5,
  -0.0015237508909061333,
  -0.0027916148782430755,
  -0.003466774959791806,
  -0.003350962727997039,
  -0.002423490818577812,
  -8.573308438372274E-4,
  0.0010107007204297079,
  0.002750645455701248,
  0.003936896457561508,
  0.004250491539207785,
  0.0035622216594230075,
  0.001975208611073764,
  -1.8542560464550656E-4,
  -0.002436635883433582,
  -0.004243523162201222,
  -0.005144022306860182,
  -0.004864320597323889,
  -0.0033961669120631923,
  -0.0010157969232050628,
  0.0017640183853998488,
  0.004301382694921531,
  0.005970492569088992,
  0.006312270865131829,
  0.005155151216843775,
  0.00267531742752618,
  -6.220376923182277E-4,
  -0.0040007669120076415,
  -0.006653720667027894,
  -0.00789027034773527,
  -0.007309361437502265,
  -0.004915927762451134,
  -0.0011494395193005014,
  0.0031884721741939907,
  0.007097304423149672,
  0.009600240781762817,
  0.009978089044790802,
  0.007960593857803476,
  0.003827541742480885,
  -0.001611302887443791,
  -0.007161785313676882,
  -0.01149319757802605,
  -0.013439258780270014,
  -0.012287715683153951,
  -0.007991306910334844,
  -0.0012454863509181815,
  0.006596421611324937,
  0.013766067738673803,
  0.018441177337272283,
  0.019156584408112534,
  0.015180151069720411,
  0.00677032742371458,
  -0.004749860819918029,
  -0.01713324404305088,
  -0.02755241847715629,
  -0.03309351478055939,
  -0.03131257623929806,
  -0.020749377789910314,
  -0.0012961168045209834,
  0.025658343415576833,
  0.05734841717274692,
  0.09000599376999416,
  0.11943080857537725,
  0.1416592346432449,
  0.15361340478052152,
  0.15361340478052152,
  0.1416592346432449,
  0.11943080857537725,
  0.09000599376999416,
  0.05734841717274692,
  0.025658343415576833,
  -0.0012961168045209834,
  -0.020749377789910314,
  -0.03131257623929806,
  -0.03309351478055939,
  -0.02755241847715629,
  -0.01713324404305088,
  -0.004749860819918029,
  0.00677032742371458,
  0.015180151069720411,
  0.019156584408112534,
  0.018441177337272283,
  0.013766067738673803,
  0.006596421611324937,
  -0.0012454863509181815,
  -0.007991306910334844,
  -0.012287715683153951,
  -0.013439258780270014,
  -0.01149319757802605,
  -0.007161785313676882,
  -0.001611302887443791,
  0.003827541742480885,
  0.007960593857803476,
  0.009978089044790802,
  0.009600240781762817,
  0.007097304423149672,
  0.0031884721741939907,
  -0.0011494395193005014,
  -0.004915927762451134,
  -0.007309361437502265,
  -0.00789027034773527,
  -0.006653720667027894,
  -0.0040007669120076415,
  -6.220376923182277E-4,
  0.00267531742752618,
  0.005155151216843775,
  0.006312270865131829,
  0.005970492569088992,
  0.004301382694921531,
  0.0017640183853998488,
  -0.0010157969232050628,
  -0.0033961669120631923,
  -0.004864320597323889,
  -0.005144022306860182,
  -0.004243523162201222,
  -0.002436635883433582,
  -1.8542560464550656E-4,
  0.001975208611073764,
  0.0035622216594230075,
  0.004250491539207785,
  0.003936896457561508,
  0.002750645455701248,
  0.0010107007204297079,
  -8.573308438372274E-4,
  -0.002423490818577812,
  -0.003350962727997039,
  -0.003466774959791806,
  -0.0027916148782430755,
  -0.0015237508909061333,
  1.5782101532487468E-5,
  0.0014631138946034443,
  0.0024962485484619486,
  0.0029054873877452656,
  0.0026344799267518215,
  0.0017839974961737681,
  5.800943184252537E-4,
  -6.843917945666481E-4,
  -0.001719951714741682,
  -0.0023059537145225933,
  -0.0023362150309353667,
  -0.001836694397785154,
  -9.515076717914393E-4,
  9.651080349715515E-5,
  0.0010609488372002507,
  0.0017291494432319543,
  0.001968171371702879,
  0.0017501592614373124,
  0.001152244506396169,
  3.3279867848702566E-4,
  -5.096807459169467E-4,
  -0.001183475558895642,
  -0.0015471528670520397,
  -0.0015378439198133586,
  -0.0011808734837233828,
  -5.784712278437567E-4,
  1.1840280342887127E-4,
  7.471071379296708E-4,
  0.0011709266198968425,
  0.0013082144879538017,
  0.001147404855294023,
  7.446435043276913E-4,
  2.0742040729975975E-4,
  -3.3417774858638923E-4,
  -7.573080079609536E-4,
  -9.741753694341827E-4,
  -9.493462386505837E-4,
  -7.039569659590131E-4,
  -3.073389722173345E-4,
  1.4220976499232748E-4,
  5.415668869773104E-4,
  8.06414523551526E-4,
  8.880806343799871E-4,
  7.836728631828374E-4,
  5.31298393976394E-4,
  2.008423669415105E-4,
  -1.254616407409903E-4,
  -3.717306572653342E-4,
  -4.8448220172512884E-4,
  -4.4378936126212193E-4,
  -2.6512193672629554E-4,
  7.009460790638146E-6,
  3.112974111527295E-4,
  5.815008317447361E-4,
  7.65999855244165E-4,
  8.295882692759705E-4,
  7.687197868509025E-4,
  6.025817992035853E-4,
  3.684946565411867E-4,
  1.1449907195741894E-4,
  -1.1302822556929583E-4,
  -2.795995105134109E-4,
  -3.672286989580432E-4,
  -3.749212927272262E-4,
  -7.515544038614662E-4
};
static const int L_size = 258;












#if 0
/*
Parks-McClellan FIR Filter Design

Filter type: Low pass
Passband: 0 - 0.07291666666666666667
Order: 197
Passband ripple: 1.0 dB
Transition band: 0.010416667
Stopband attenuation: 60.0 dB
*/
static const float p_H[] =
{
  3.9581589665931217E-4,
  -3.4557842787400877E-4,
  -7.162596032290514E-4,
  -0.0013025002137309091,
  -0.002044889116767399,
  -0.0028593518672240196,
  -0.003634375407531506,
  -0.004242525468726275,
  -0.004560769579145035,
  -0.004494674095259986,
  -0.004001101531994357,
  -0.003104408227155561,
  -0.0019014176128998412,
  -5.518832749745851E-4,
  7.455751674107329E-4,
  0.0017881713086681213,
  0.002406995639013516,
  0.002501633450919955,
  0.0020653768887604488,
  0.001195308683759525,
  7.070379361594518E-5,
  -0.0010698452564073856,
  -0.001981389755189601,
  -0.0024604750202581157,
  -0.0023909474938377984,
  -0.001772700115160269,
  -7.267144374694439E-4,
  5.261415293303111E-4,
  0.0017093023977519536,
  0.002549523668426955,
  0.002838560600989886,
  0.002483620450156777,
  0.001534358390665843,
  1.789059442944144E-4,
  -0.0012912242408018905,
  -0.002541918394222353,
  -0.0032712099896826338,
  -0.003280970568052606,
  -0.002526935415862894,
  -0.0011402837625506853,
  5.943475064967613E-4,
  0.002294240289415111,
  0.0035618560640166856,
  0.0040759946136675745,
  0.0036709223254172167,
  0.002384325091299706,
  4.612458646324361E-4,
  -0.0016897944552259547,
  -0.0035814504095159783,
  -0.004755874529434059,
  -0.004893015817007282,
  -0.0038936723991589164,
  -0.0019171161938074523,
  6.390597109441933E-4,
  0.0032159736814200623,
  0.00521278799023273,
  0.006123178156927249,
  0.005660387562894724,
  0.0038378311324171713,
  9.873756431389921E-4,
  -0.0022961559054488685,
  -0.005274742257868387,
  -0.00722855949104514,
  -0.007624491480897971,
  -0.006253588872975333,
  -0.003303571767868804,
  6.550165846406549E-4,
  0.004772049360390883,
  0.008093288668198062,
  0.00977309351456446,
  0.009279183340368893,
  0.0065413693299397856,
  0.0020064854750140816,
  -0.003420341115022962,
  -0.008543896306715915,
  -0.01212810029460352,
  -0.013175479033304793,
  -0.011178975624082932,
  -0.0062856467486323495,
  6.703584735370948E-4,
  0.008284981517483988,
  0.014839301177263108,
  0.018649951997411172,
  0.018448647105320945,
  0.013713234445013036,
  0.004876925193413125,
  -0.006638043752972113,
  -0.01858387806069714,
  -0.02823191429200137,
  -0.03284386687267944,
  -0.03018823555897896,
  -0.019005423743712266,
  6.696899685298684E-4,
  0.027396611492024162,
  0.05846085411781481,
  0.09023705678988894,
  0.118726368796134,
  0.14017928127551404,
  0.15169552989135682,
  0.15169552989135682,
  0.14017928127551404,
  0.118726368796134,
  0.09023705678988894,
  0.05846085411781481,
  0.027396611492024162,
  6.696899685298684E-4,
  -0.019005423743712266,
  -0.03018823555897896,
  -0.03284386687267944,
  -0.02823191429200137,
  -0.01858387806069714,
  -0.006638043752972113,
  0.004876925193413125,
  0.013713234445013036,
  0.018448647105320945,
  0.018649951997411172,
  0.014839301177263108,
  0.008284981517483988,
  6.703584735370948E-4,
  -0.0062856467486323495,
  -0.011178975624082932,
  -0.013175479033304793,
  -0.01212810029460352,
  -0.008543896306715915,
  -0.003420341115022962,
  0.0020064854750140816,
  0.0065413693299397856,
  0.009279183340368893,
  0.00977309351456446,
  0.008093288668198062,
  0.004772049360390883,
  6.550165846406549E-4,
  -0.003303571767868804,
  -0.006253588872975333,
  -0.007624491480897971,
  -0.00722855949104514,
  -0.005274742257868387,
  -0.0022961559054488685,
  9.873756431389921E-4,
  0.0038378311324171713,
  0.005660387562894724,
  0.006123178156927249,
  0.00521278799023273,
  0.0032159736814200623,
  6.390597109441933E-4,
  -0.0019171161938074523,
  -0.0038936723991589164,
  -0.004893015817007282,
  -0.004755874529434059,
  -0.0035814504095159783,
  -0.0016897944552259547,
  4.612458646324361E-4,
  0.002384325091299706,
  0.0036709223254172167,
  0.0040759946136675745,
  0.0035618560640166856,
  0.002294240289415111,
  5.943475064967613E-4,
  -0.0011402837625506853,
  -0.002526935415862894,
  -0.003280970568052606,
  -0.0032712099896826338,
  -0.002541918394222353,
  -0.0012912242408018905,
  1.789059442944144E-4,
  0.001534358390665843,
  0.002483620450156777,
  0.002838560600989886,
  0.002549523668426955,
  0.0017093023977519536,
  5.261415293303111E-4,
  -7.267144374694439E-4,
  -0.001772700115160269,
  -0.0023909474938377984,
  -0.0024604750202581157,
  -0.001981389755189601,
  -0.0010698452564073856,
  7.070379361594518E-5,
  0.001195308683759525,
  0.0020653768887604488,
  0.002501633450919955,
  0.002406995639013516,
  0.0017881713086681213,
  7.455751674107329E-4,
  -5.518832749745851E-4,
  -0.0019014176128998412,
  -0.003104408227155561,
  -0.004001101531994357,
  -0.004494674095259986,
  -0.004560769579145035,
  -0.004242525468726275,
  -0.003634375407531506,
  -0.0028593518672240196,
  -0.002044889116767399,
  -0.0013025002137309091,
  -7.162596032290514E-4,
  -3.4557842787400877E-4,
  3.9581589665931217E-4
};
static const int L_size = 198;



/*
Parks-McClellan FIR Filter Design

Filter type: Low pass
Passband: 0 - 0.4375
Order: 41
Passband ripple: 1.0 dB
Transition band: 0.05
Stopband attenuation: 60.0 dB
*/
static const float p_H[] =
{
  0.017156006015022405,
  -0.0038551376363189457,
  0.0031842714868904184,
  -0.0016476936494097896,
  -7.794697697892643E-4,
  0.0040311360575206985,
  -0.007927911231337991,
  0.012176576666264446,
  -0.01638869647652104,
  0.02009765018498382,
  -0.022765744618565936,
  0.023788843552188,
  -0.022508845241206887,
  0.018250519857717112,
  -0.01030070315530164,
  -0.002397887880801566,
  0.02139626317164366,
  -0.049947708472887486,
  0.09655612114196968,
  -0.19312723575522014,
  0.630154112417503,
  0.630154112417503,
  -0.19312723575522014,
  0.09655612114196968,
  -0.049947708472887486,
  0.02139626317164366,
  -0.002397887880801566,
  -0.01030070315530164,
  0.018250519857717112,
  -0.022508845241206887,
  0.023788843552188,
  -0.022765744618565936,
  0.02009765018498382,
  -0.01638869647652104,
  0.012176576666264446,
  -0.007927911231337991,
  0.0040311360575206985,
  -7.794697697892643E-4,
  -0.0016476936494097896,
  0.0031842714868904184,
  -0.0038551376363189457,
  0.017156006015022405
};
static const int L_size = 42;
#endif


/*
First stage 48kHz <-> 16kHz (8kHz cut-off)

Parks-McClellan FIR Filter Design

Filter type: Low pass
Passband: 0 - 0.07291666666666666667 (0 - 3500Hz)
Order: 29
Passband ripple: 0.1 dB
Transition band: 0.09375 (4500Hz)
Stopband attenuation: 60.0 dB
*/
static const int L_size1 = 42;
static const float p_H1[L_size1] =
{
  -0.001104533022845565,
  1.4483111628894497E-4,
  0.0030143616079341333,
  0.007290576776838937,
  0.010111003515779919,
  0.007406824406566465,
  -0.0033299650331323396,
  -0.019837606041858764,
  -0.03369491630668587,
  -0.03261321520115128,
 -0.006227597046237875,
  0.0472474773894006,
  0.11741132225100549,
  0.18394793387595304,
  0.22449383849677723,
  0.22449383849677723,
  0.18394793387595304,
  0.11741132225100549,
  0.0472474773894006,
  -0.006227597046237875,
  -0.03261321520115128,
  -0.03369491630668587,
  -0.019837606041858764,
  -0.0033299650331323396,
  0.007406824406566465,
  0.010111003515779919,
  0.007290576776838937,
  0.0030143616079341333,
  1.4483111628894497E-4,
  -0.001104533022845565
};


/*
8kHz <-> 16kHz

Parks-McClellan FIR Filter Design

Filter type: Low pass
Passband: 0 - 0.21875 (0 - 3500Hz)
Order: 89
Passband ripple: 0.1 dB
Transition band: 0.03125 (500Hz)
Stopband attenuation: 62.0 dB
*/
static const int L_size2 = 90;
static const float p_H2[L_size2] =
{
  4.4954770039301524E-4,
  -8.268172996066966E-4,
  -0.002123078315145856,
  -0.0015479438021244402,
  7.273225897575334E-4,
  0.0013974534015721682,
  -7.334976988828609E-4,
  -0.0019468497129111343,
  4.1355600739715313E-4,
  0.002536269673526767,
  1.5022005765340837E-4,
  -0.003101672879509627,
  -9.95458834752388E-4,
  0.00354467345212626,
  0.0021278523715996304,
  -0.0037661500010028543,
  -0.00353539274926452,
  0.0036538076631845626,
  0.005173997894832533,
  -0.003092155201519595,
  -0.006964869006639621,
  0.001972228534636602,
  0.008799395727660558,
  -1.908879053321082E-4,
  -0.01053574038718076,
  -0.0023470042371114453,
  0.011994344679012392,
  0.005724529332766167,
  -0.012958939230749365,
  -0.010021252057195512,
  0.013170597031930194,
  0.015338845914920506,
  -0.012300860896401845,
  -0.021850249720503187,
  0.009887401534293974,
  0.029911674274011077,
  -0.0051694230705885726,
  -0.04035692286061595,
  -0.0034027067537959477,
  0.05542257393205645,
  0.01998932901259646,
  -0.08281607098012608,
  -0.0619525333134873,
  0.17225790685629527,
  0.42471952920395545,
  0.42471952920395545,
  0.17225790685629527,
  -0.0619525333134873,
  -0.08281607098012608,
  0.01998932901259646,
  0.05542257393205645,
  -0.0034027067537959477,
  -0.04035692286061595,
  -0.0051694230705885726,
  0.029911674274011077,
  0.009887401534293974,
  -0.021850249720503187,
  -0.012300860896401845,
  0.015338845914920506,
  0.013170597031930194,
  -0.010021252057195512,
  -0.012958939230749365,
  0.005724529332766167,
  0.011994344679012392,
  -0.0023470042371114453,
  -0.01053574038718076,
  -1.908879053321082E-4,
  0.008799395727660558,
  0.001972228534636602,
  -0.006964869006639621,
  -0.003092155201519595,
  0.005173997894832533,
  0.0036538076631845626,
  -0.00353539274926452,
  -0.0037661500010028543,
  0.0021278523715996304,
  0.00354467345212626,
  -9.95458834752388E-4,
  -0.003101672879509627,
  1.5022005765340837E-4,
  0.002536269673526767,
  4.1355600739715313E-4,
  -0.0019468497129111343,
  -7.334976988828609E-4,
  0.0013974534015721682,
  7.273225897575334E-4,
  -0.0015479438021244402,
  -0.002123078315145856,
  -8.268172996066966E-4,
  4.4954770039301524E-4
};


/****************************************************************************
 *
 * Public member functions
 *
 ****************************************************************************/

AudioInterpolator::AudioInterpolator(int interpolation_factor,
      	      	      	      	     const float *filter_coeff, int taps)
  : factor_L(interpolation_factor), L_size(taps), p_H(filter_coeff)
{
  //p_H = new float[taps];
  //memcpy(p_H, filter_coeff, taps * sizeof(*p_H));
  
  setInputOutputSampleRate(1, factor_L);
  p_Z = new float[L_size / factor_L];
  memset(p_Z, 0, sizeof(*p_Z) * L_size / factor_L);
} /* AudioInterpolator::AudioInterpolator */


AudioInterpolator::~AudioInterpolator(void)
{
  delete [] p_Z;
} /* AudioInterpolator::~AudioInterpolator */




/****************************************************************************
 *
 * Protected member functions
 *
 ****************************************************************************/

void AudioInterpolator::processSamples(float *dest, const float *src, int count)
{
  int orig_count = count;
  int num_taps_per_phase = L_size / factor_L;
  
  int num_out = 0;
  while (count-- > 0)
  {
      // shift Z delay line up to make room for next sample
    for (int tap = num_taps_per_phase - 1; tap > 0; tap--)
    {
      p_Z[tap] = p_Z[tap - 1];
    }

      // copy next sample from input buffer to bottom of Z delay line
    p_Z[0] = *src++;

      // calculate outputs
    for (int phase_num = 0; phase_num < factor_L; phase_num++)
    {
      	// point to the current polyphase filter
      const float *p_coeff = p_H + phase_num;

      	// calculate FIR sum
      float sum = 0.0;
      for (int tap = 0; tap < num_taps_per_phase; tap++)
      {
        sum += *p_coeff * p_Z[tap];
        p_coeff += factor_L;          /* point to next coefficient */
      }
      *dest++ = sum;     /* store sum and point to next output */
      num_out++;
    }
  }

  //printf("num_out=%d  orig_count=%d\n", num_out, orig_count);
  assert(num_out == orig_count * factor_L);
  
} /* AudioInterpolator::processSamples */




/****************************************************************************
 *
 * Private member functions
 *
 ****************************************************************************/



/*
 * This file has not been truncated
 */

